version: 2

models:
  # ============================================
  # METRICS BUILDING BLOCKS
  # ============================================
  # These views extract metrics from fact tables in a lean format.
  # Each model only includes metric_key, metric_value, and relevant dimension columns.
  # 
  # metric_name, metric_category, metric_unit, and metric_level come from dim_metric
  # (single source of truth). fact_global_metrics handles the join and column alignment.
  
  - name: metrics_sales_order
    description: |
      Sales order metrics from fact_sales_order (order-level granularity).
      One row per metric per sales order.
      
      Metrics: SO_REVENUE, SO_SUBTOTAL, SO_TAX, SO_FREIGHT, 
               SO_QUANTITY, SO_LINE_ITEMS, SO_DISCOUNT, SO_DAYS_TO_SHIP
    columns:
      - name: date_key
        description: "Order date key (YYYYMMDD format)"
      - name: report_date
        description: "Max transaction date (snapshot date)"
      - name: source_table
        description: "Always 'sales_order'"
      - name: source_record_id
        description: "salesorderid from fact_sales_order"
      - name: metric_key
        description: "Metric identifier (joins to dim_metric)"
      - name: metric_value
        description: "Numeric metric value"
      - name: customer_key
        description: "FK to dim_customer"
      - name: employee_key
        description: "FK to dim_employee"
      - name: territory_key
        description: "FK to dim_territory"
      - name: ship_method_key
        description: "FK to ship method"
      - name: credit_card_key
        description: "FK to credit card"
      - name: online_order_flag
        description: "'Online' or 'In-Store'"
      - name: order_status
        description: "Order status code"

  - name: metrics_sales_line
    description: |
      Sales line metrics from fact_sales_order_line (line-item granularity).
      One row per metric per line item.
      
      Metrics: SOL_REVENUE, SOL_GROSS_AMOUNT, SOL_QUANTITY, SOL_PROFIT,
               SOL_PROFIT_MARGIN, SOL_DISCOUNT, SOL_UNIT_PRICE
    columns:
      - name: date_key
        description: "Order date key (YYYYMMDD format)"
      - name: report_date
        description: "Max transaction date (snapshot date)"
      - name: source_table
        description: "Always 'sales_order_line'"
      - name: source_record_id
        description: "salesorderdetailid from fact_sales_order_line"
      - name: metric_key
        description: "Metric identifier (joins to dim_metric)"
      - name: metric_value
        description: "Numeric metric value"
      - name: customer_key
        description: "FK to dim_customer"
      - name: product_key
        description: "FK to dim_product"
      - name: employee_key
        description: "FK to dim_employee"
      - name: territory_key
        description: "FK to dim_territory"
      - name: special_offer_key
        description: "FK to special offer"
      - name: parent_order_id
        description: "Parent sales order ID"
      - name: has_discount
        description: "'Yes' or 'No'"

  - name: metrics_inventory
    description: |
      Inventory metrics from fact_inventory (product/location granularity).
      One row per metric per product/location combination.
      
      Metrics: INV_QUANTITY, INV_VALUE, INV_ABOVE_SAFETY, INV_REORDER_PCT
    columns:
      - name: date_key
        description: "Report date key (YYYYMMDD format)"
      - name: report_date
        description: "Snapshot date"
      - name: source_table
        description: "Always 'inventory'"
      - name: source_record_id
        description: "Row number for product/location"
      - name: metric_key
        description: "Metric identifier (joins to dim_metric)"
      - name: metric_value
        description: "Numeric metric value"
      - name: product_key
        description: "FK to dim_product"
      - name: location_key
        description: "Location identifier"
      - name: inventory_status
        description: "'In Stock', 'Out of Stock', 'Below Safety Stock', 'At Reorder Point'"
      - name: location_name
        description: "Inventory location name"
      - name: safety_stock_level
        description: "Safety stock threshold"
      - name: reorder_point
        description: "Reorder point threshold"

  - name: metrics_purchase_order
    description: |
      Purchase order metrics from fact_purchase_order (order-level granularity).
      One row per metric per purchase order.
      
      Metrics: PO_AMOUNT, PO_SUBTOTAL, PO_TAX, PO_FREIGHT, PO_QUANTITY,
               PO_RECEIVED_QTY, PO_REJECTED_QTY, PO_REJECTION_RATE,
               PO_FULFILLMENT_RATE, PO_DAYS_TO_SHIP
    columns:
      - name: date_key
        description: "Order date key (YYYYMMDD format)"
      - name: report_date
        description: "Max transaction date (snapshot date)"
      - name: source_table
        description: "Always 'purchase_order'"
      - name: source_record_id
        description: "purchaseorderid from fact_purchase_order"
      - name: metric_key
        description: "Metric identifier (joins to dim_metric)"
      - name: metric_value
        description: "Numeric metric value"
      - name: vendor_key
        description: "FK to dim_vendor"
      - name: employee_key
        description: "FK to dim_employee"
      - name: ship_method_key
        description: "FK to ship method"
      - name: order_status
        description: "Purchase order status code"

  - name: metrics_work_order
    description: |
      Work order metrics from fact_work_order (work order granularity).
      One row per metric per work order.
      
      Metrics: WO_ORDER_QTY, WO_GOOD_QTY, WO_SCRAPPED_QTY, WO_SCRAP_RATE,
               WO_PLANNED_COST, WO_ACTUAL_COST, WO_COST_VARIANCE,
               WO_COST_VARIANCE_PCT, WO_PRODUCTION_DAYS, WO_ACTUAL_HOURS,
               WO_HOURS_PER_UNIT
    columns:
      - name: date_key
        description: "Start date key (YYYYMMDD format)"
      - name: report_date
        description: "Max transaction date (snapshot date)"
      - name: source_table
        description: "Always 'work_order'"
      - name: source_record_id
        description: "workorderid from fact_work_order"
      - name: metric_key
        description: "Metric identifier (joins to dim_metric)"
      - name: metric_value
        description: "Numeric metric value"
      - name: product_key
        description: "FK to dim_product"
      - name: scrap_reason_key
        description: "FK to scrap reason"
      - name: delivery_status
        description: "'On Time', 'Slightly Late', 'Late'"
      - name: scrap_reason_name
        description: "Scrap reason or 'None'"
      - name: number_of_operations
        description: "Number of routing operations"

  - name: metrics_employee_quota
    description: |
      Employee quota metrics from fact_employee_quota (employee/period granularity).
      One row per metric per employee quota period.
      
      Metrics: EQ_QUOTA, EQ_SALES_YTD, EQ_SALES_LAST_YEAR,
               EQ_ACHIEVEMENT_PCT, EQ_QUOTA_VARIANCE, EQ_BONUS
    columns:
      - name: date_key
        description: "Quota date key (YYYYMMDD format)"
      - name: report_date
        description: "Max transaction date (snapshot date)"
      - name: source_table
        description: "Always 'employee_quota'"
      - name: source_record_id
        description: "employee_key (one quota per employee)"
      - name: metric_key
        description: "Metric identifier (joins to dim_metric)"
      - name: metric_value
        description: "Numeric metric value"
      - name: employee_key
        description: "FK to dim_employee"
      - name: territory_key
        description: "FK to dim_territory"
      - name: quota_status
        description: "'Achieved', 'Near Target', 'Below Target'"
      - name: commission_pct
        description: "Commission percentage"

  - name: metrics_derived
    description: |
      Derived strategic metrics (L3-L5) calculated from operational data.
      Company-wide aggregates for KPIs and executive dashboards.
      Granularity: One row per metric (no dimension breakdowns).
      
      Metrics:
      - TOTAL_REVENUE: Sum of all sales order revenue
      - GROSS_PROFIT: Sum of all line item profits
      - GROSS_MARGIN: Gross profit as % of revenue
      - INVENTORY_TURNOVER: Estimated inventory turns
      - CUSTOMER_SATISFACTION: Composite delivery score
      - PRODUCTION_EFFICIENCY: Production cost efficiency score
      - SUPPLIER_QUALITY: 100 - avg rejection rate
      - SUPPLIER_RELIABILITY: Average fulfillment rate
      - SALES_PERFORMANCE: Average quota achievement
    columns:
      - name: date_key
        description: "Report date key (YYYYMMDD format)"
      - name: report_date
        description: "Snapshot date"
      - name: source_table
        description: "Always 'derived'"
      - name: source_record_id
        description: "Always 1 (single aggregate row)"
      - name: metric_key
        description: "Metric identifier (joins to dim_metric)"
      - name: metric_value
        description: "Calculated aggregate value"
